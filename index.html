<!DOCTYPE html>
<html>
<head>
    <title>SHELTER 防护系统测试页</title>
    <style>
        .test-section { margin: 20px; padding: 15px; border: 1px solid #ccc; }
        .test-result { padding: 10px; margin: 5px 0; }
        .success { background: #dfffdf; color: #2b532b; }
        .failure { background: #ffe5e5; color: #8b0000; }
    </style>
</head>
<body>
    <h1>防护系统功能测试</h1>
    
    <!-- 测试用例容器 -->
    <div class="test-section" id="basic-tests">
        <h2>基础功能测试</h2>
        <button onclick="runBasicTests()">执行基础测试</button>
        <div id="test-results"></div>
    </div>

    <!-- 指纹混淆测试 -->
    <div class="test-section" id="fingerprint-tests">
        <h2>指纹混淆测试</h2>
        <button onclick="runFingerprintTests()">执行指纹测试</button>
        <div id="fingerprint-results"></div>
    </div>

    <!-- 动态注入测试 -->
    <div id="dynamic-injection"></div>

<script>
// 基础功能测试套件
function runBasicTests() {
    const results = document.getElementById('test-results');
    results.innerHTML = '';

    // 测试1: 平行DOM存在性检查
    setTimeout(() => { // 等待初始化完成
        testCase({
            name: '平行DOM初始化',
            assert: () => document.documentElement.hasAttribute('data-parallel-dom'),
            resultElem: results
        });

        // 测试2: ID自动生成检查
        testCase({
            name: '元素ID生成',
            assert: () => {
                const testElem = document.createElement('div');
                document.body.appendChild(testElem);
                return testElem.id.startsWith('id-');
            },
            cleanup: () => testElem.remove(),
            resultElem: results
        });

        // 测试3: 原生API覆写检查
        testCase({
            name: 'API覆写检测',
            assert: () => {
                const originalAppend = Node.prototype.appendChild;
                return originalAppend.toString() !== nativeAppend.toString();
            },
            resultElem: results
        });
    }, 500);
}

// 指纹测试套件
function runFingerprintTests() {
    const results = document.getElementById('fingerprint-results');
    results.innerHTML = '';

    // 测试1: Canvas指纹混淆
    testCase({
        name: 'Canvas指纹混淆',
        assert: () => {
            const canvas = document.createElement('canvas');
            return canvas.toDataURL() !== cleanCanvas.toDataURL();
        },
        resultElem: results
    });

    // 测试2: WebGL特征混淆
    testCase({
        name: 'WebGL混淆',
        assert: async () => {
            const renderer = await getWebGLRenderer();
            return renderer.includes('[protected]');
        },
        resultElem: results
    });

    // 测试3: AudioContext指纹
    testCase({
        name: '音频指纹保护',
        assert: () => {
            const ctx = new AudioContext();
            return ctx.destination.channelCount !== 2;
        },
        resultElem: results
    });
}

// 通用测试用例执行器
function testCase({name, assert, cleanup, resultElem}) {
    const result = document.createElement('div');
    result.className = 'test-result';
    
    try {
        const testResult = assert();
        result.classList.add(testResult ? 'success' : 'failure');
        result.textContent = `${name}: ${testResult ? '成功' : '失败'}`;
        
        if (typeof cleanup === 'function') cleanup();
    } catch (e) {
        result.classList.add('failure');
        result.textContent = `${name}: 错误 - ${e.message}`;
    }
    
    resultElem.appendChild(result);
    result.scrollIntoView({behavior: 'smooth'});
}

// 辅助函数：获取WebGL渲染器信息
async function getWebGLRenderer() {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl');
    return gl.getParameter(gl.RENDERER);
}

// 初始化防护系统
const script = document.createElement('script');
script.src = 'path/to/your/shelter.js'; // 替换为实际路径
document.head.appendChild(script);

// 启动自动测试
script.onload = () => {
    setTimeout(() => {
        runBasicTests();
        runFingerprintTests();
    }, 1000);
};
</script>
</body>
</html> 
